---
---
<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.20.1/ol.css" type="text/css">
		<link rel="stylesheet" href="styles/map.css" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.20.1/ol.js" integrity="sha256-iSrl5MfvlrdpraHdyizBbbV6H6ikGFuVLv1OV08uWhY=" crossorigin="anonymous"></script>
    <title>OpenLayers 3 example</title>
  </head>
  <body>
    <h2>My Map</h2>
    <div id="map" class="map"></div>
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>

    <script type="text/javascript">
		  var eventIconStyle = new ol.style.Style({
		    image: new ol.style.Icon({
		      scale: 0.05,
		      anchor: [0.5, 1],
		      src: 'images/map-pin.png'
		    })
		  });

      var events = {{ site.data.events | jsonify }};
      var eventsLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: eventIconStyle
      });

			function fromLatLong(coordsString) {
				var coords = coordsString.split(',').map(function(n) { return Number(n)});
				var transformed = ol.proj.transform([coords[1], coords[0]], 'EPSG:4326', 'EPSG:3857');
				return new ol.geom.Point(transformed);
			}

			Object.keys(events).forEach(function(eventLocation) {
				var eventData = events[eventLocation];

				eventsLayer.getSource().addFeature(new ol.Feature({
				  name: eventData.name,
					signup: eventData.signup,
					geometry: fromLatLong(eventData.location)
				}));
			});

      /**
       * Elements that make up the popup.
       */
      var container = document.getElementById('popup');
      var content = document.getElementById('popup-content');
      var closer = document.getElementById('popup-closer');


      /**
       * Create an overlay to anchor the popup to the map.
       */
      var overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
        element: container,
        autoPan: true,
        autoPanAnimation: {
          duration: 250
        }
      }));

      /**
       * Add a click handler to hide the popup.
       * @return {boolean} Don't follow the href.
       */
      closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
      };

      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
					eventsLayer
        ],
				overlays: [overlay],
        view: new ol.View({
          center: ol.proj.transform([13.4043503, 52.5195078], 'EPSG:4326', 'EPSG:3857'),
          zoom: 2.5
        })
      });

      /**
       * Add a click handler to the map to render the popup.
       */
      map.on('singleclick', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
          if (layer == eventsLayer)
             return feature;
          }
        );
        if (!feature) {
          overlay.setPosition(undefined);
          return;
        }
        var geometry = feature.getGeometry();
        var coord = geometry.getCoordinates();

        content.innerHTML = '<h3>'+feature.get('name')+'</h3><a href="'+feature.get('signup')+'">Sign Up</a>';

        overlay.setPosition(coord);
      });


    </script>
  </body>
</html>
